facet_wrap(.~ Genotype)+
xlim(0, 31) + ylim(0, 80)
eps_func_hill <- function(Time, r_eps){
1/(1+ (Time/r_eps)^1)
}
eps_vec_hill <- sapply(ts_pred, eps_func_hill, r_eps = 7)
# ggplot()+
#   geom_line(aes(x = ts_pred, y=eps_vec_hill), col=4)+
#   geom_line(aes(x = ts_pred, y=eps_vec))+
#   scale_x_log10(limits=c(0.01, 30), breaks=c(0.01, 0.03, 0.1, 0.3, 1, 3, 10, 30))
eps_func <- function(Time, r_eps){
#eps_func_exp(Time, r_eps)
eps_func_hill(Time, r_eps)
}
ode_func <- function (Time, y, parms) {
pro_pos = (131619) #counts_df %>% filter(subpop == "BrdU_Pro_B") %>%
#summarise(mean(cell_counts))
pro_neg = (378491.4) #counts_df %>% filter(subpop == "Pro_B") %>%
#summarise(mean(cell_counts)) - pro_pos
with(as.list(c(y, parms)),{
delta = exp(delta_log)
rho = exp(rho_log)
rho_dko = exp(rho_dko_log)
delta_dko = exp(delta_dko_log)
r_eps = 5
theta = (rho - delta) * (y1+y2+y3)/(pro_neg+pro_pos)
theta_dko = (rho_dko - delta_dko) * (y4+y5+y6)/(pro_neg+pro_pos)
alpha = 1
## in WT
# L2 pop
dy1 <- theta * (1 - alpha) * pro_pos + rho * eps_func(Time, r_eps) * (2*y2 + y1) - rho * (1-eps_func(Time, r_eps)) * y1 - delta * y1
# L1 pop
dy2 <- theta * alpha * pro_pos + rho * eps_func(Time, r_eps) * (2*y3 - y1) + 2 * rho * (1-eps_func(Time, r_eps)) * y1 - delta * y2
# U pop
dy3 <- theta * pro_neg - rho * eps_func(Time, r_eps) * y3 + rho * (1-eps_func(Time, r_eps)) * (y2 + y3) - delta * y3
## in DKO
# L2 pop
dy4 <- theta_dko * (1 - alpha) * pro_pos + rho_dko * eps_func(Time, r_eps) * (2*y5+ y4) - rho_dko * (1-eps_func(Time, r_eps)) * y4 - delta_dko * y4
# L1 pop
dy5 <- theta_dko * alpha * pro_pos + rho_dko * eps_func(Time, r_eps) * (2*y6 - y4) + 2 * rho_dko * (1-eps_func(Time, r_eps)) * y4 - delta_dko * y5
# U pop
dy6 <- theta_dko * pro_neg - rho_dko * eps_func(Time, r_eps) * y6 + rho_dko * (1-eps_func(Time, r_eps)) * (y5 + y6) - delta_dko * y6
list(c(dy1, dy2, dy3, dy4, dy5, dy6))
})
}
init_cond_wt <- c("y1" = 0.0, "y2" = 0, "y3" = 372151)
init_cond_dko <- c("y4" = 0.0, "y5" = 0, "y6" = 83027)
init_cond <- c(init_cond_wt, init_cond_dko)
params <- c("rho_log" = -3, "delta_log" = -5, "rho_dko_log" = -4, "delta_dko_log" = -5)#, "r_eps" = 0.5)
asin_transf <- function(x){asin(sqrt(x))}
pred_df <- data.frame(ode(y=init_cond, times=c(0, 4, 18, 30), func=ode_func, parms=params))%>%
mutate(wt_Total = y1+y2+y3,
wt_prop_brdu = (y1+y2)/wt_Total,
dko_Total = y4+y5+y6,
dko_prop_brdu = (y4+y5)/dko_Total) %>%
filter(time != 0) %>% rename(Time_h = time)
#model optimization
LL_func <- function(param, boot_data1, boot_data2, init_conds) {
k <- length(param)        #number of unknown parameters
n1 <-  nrow(boot_data1)
n2 <-  nrow(boot_data2)
pred_df <- data.frame(ode(y=init_conds, times=c(0, 4, 18, 30), func=ode_func, parms=param))%>%
mutate(wt_Total = y1+y2+y3,
wt_prop_brdu = (y1+y2)/wt_Total,
dko_Total = y4+y5+y6,
dko_prop_brdu = (y4+y5)/dko_Total) %>%
filter(time != 0) %>% rename(Time_h = time)
pred_wt <- pred_df %>%
select(Time_h, contains('wt'))
pred_dko <- pred_df %>%
select(Time_h, contains('dko'))
wt_total <-  boot_data1$Total
wt_frac <-  boot_data1$prop_brdu
dko_total <-  boot_data2$Total
dko_frac <-  boot_data2$prop_brdu
R1 <- sum((asin_transf(pred_wt$wt_prop_brdu[time_index1]) - asin_transf(wt_frac))^2)
# R2 <- sum((log(pred_wt$wt_Total[time_index1]) - log(wt_total))^2)
R3 <- sum((asin_transf(pred_dko$dko_prop_brdu[time_index2]) - asin_transf(dko_frac))^2)
# R4 <- sum((log(pred_dko$dko_Total[time_index2]) - log(dko_total))^2)
logl <- -(n1/2)*(log(R1))  - (n2/2)*(log(R3))
return(-logl)
}
fit_LL <- optim(par=params, fn=LL_func,
boot_data1 = large_preB_wt, boot_data2 = large_preB_dko, init_conds = init_cond,
method = "Nelder-Mead",
control = list(trace = 6, maxit=2000))
fit_LL
par_est <- fit_LL$par
exp(fit_LL$par)
## predictions
pred_df <- data.frame(ode(y=init_cond, times=seq(0, 30, by=0.01), func=ode_func, parms=par_est))%>%
mutate(wt_Total = y1+y2+y3,
wt_prop_brdu = (y1+y2)/wt_Total,
dko_Total = y4+y5+y6,
dko_prop_brdu = (y4+y5)/dko_Total,
Time_h = time) %>%
select(Time_h, contains('prop')) %>%
gather(-Time_h, key = "genotype", value = "prop_brdu") %>%
mutate(Genotype = ifelse(grepl("wt", genotype), "WT", "dKO"))
ggplot()+
geom_point(data = large_preB_df, aes(x=Time_h, y=prop_brdu *100, col=Genotype))+
geom_line(data = pred_df, aes(x=Time_h, y=prop_brdu*100, col=Genotype)) +
facet_wrap(.~ Genotype)+
xlim(0, 31) + ylim(0, 80)
eps_func_hill <- function(Time, r_eps){
1/(1+ (Time/r_eps)^1)
}
eps_vec_hill <- sapply(ts_pred, eps_func_hill, r_eps = 7)
# ggplot()+
#   geom_line(aes(x = ts_pred, y=eps_vec_hill), col=4)+
#   geom_line(aes(x = ts_pred, y=eps_vec))+
#   scale_x_log10(limits=c(0.01, 30), breaks=c(0.01, 0.03, 0.1, 0.3, 1, 3, 10, 30))
eps_func <- function(Time, r_eps){
#eps_func_exp(Time, r_eps)
eps_func_hill(Time, r_eps)
}
ode_func <- function (Time, y, parms) {
pro_pos = (131619) #counts_df %>% filter(subpop == "BrdU_Pro_B") %>%
#summarise(mean(cell_counts))
pro_neg = (378491.4) #counts_df %>% filter(subpop == "Pro_B") %>%
#summarise(mean(cell_counts)) - pro_pos
with(as.list(c(y, parms)),{
delta = exp(delta_log)
rho = exp(rho_log)
rho_dko = exp(rho_dko_log)
delta_dko = exp(delta_dko_log)
r_eps = 7
theta = (rho - delta) * (y1+y2+y3)/(pro_neg+pro_pos)
theta_dko = (rho_dko - delta_dko) * (y4+y5+y6)/(pro_neg+pro_pos)
alpha = 1
## in WT
# L2 pop
dy1 <- theta * (1 - alpha) * pro_pos + rho * eps_func(Time, r_eps) * (2*y2 + y1) - rho * (1-eps_func(Time, r_eps)) * y1 - delta * y1
# L1 pop
dy2 <- theta * alpha * pro_pos + rho * eps_func(Time, r_eps) * (2*y3 - y1) + 2 * rho * (1-eps_func(Time, r_eps)) * y1 - delta * y2
# U pop
dy3 <- theta * pro_neg - rho * eps_func(Time, r_eps) * y3 + rho * (1-eps_func(Time, r_eps)) * (y2 + y3) - delta * y3
## in DKO
# L2 pop
dy4 <- theta_dko * (1 - alpha) * pro_pos + rho_dko * eps_func(Time, r_eps) * (2*y5+ y4) - rho_dko * (1-eps_func(Time, r_eps)) * y4 - delta_dko * y4
# L1 pop
dy5 <- theta_dko * alpha * pro_pos + rho_dko * eps_func(Time, r_eps) * (2*y6 - y4) + 2 * rho_dko * (1-eps_func(Time, r_eps)) * y4 - delta_dko * y5
# U pop
dy6 <- theta_dko * pro_neg - rho_dko * eps_func(Time, r_eps) * y6 + rho_dko * (1-eps_func(Time, r_eps)) * (y5 + y6) - delta_dko * y6
list(c(dy1, dy2, dy3, dy4, dy5, dy6))
})
}
init_cond_wt <- c("y1" = 0.0, "y2" = 0, "y3" = 372151)
init_cond_dko <- c("y4" = 0.0, "y5" = 0, "y6" = 83027)
init_cond <- c(init_cond_wt, init_cond_dko)
params <- c("rho_log" = -3, "delta_log" = -5, "rho_dko_log" = -4, "delta_dko_log" = -5)#, "r_eps" = 0.5)
asin_transf <- function(x){asin(sqrt(x))}
pred_df <- data.frame(ode(y=init_cond, times=c(0, 4, 18, 30), func=ode_func, parms=params))%>%
mutate(wt_Total = y1+y2+y3,
wt_prop_brdu = (y1+y2)/wt_Total,
dko_Total = y4+y5+y6,
dko_prop_brdu = (y4+y5)/dko_Total) %>%
filter(time != 0) %>% rename(Time_h = time)
#model optimization
LL_func <- function(param, boot_data1, boot_data2, init_conds) {
k <- length(param)        #number of unknown parameters
n1 <-  nrow(boot_data1)
n2 <-  nrow(boot_data2)
pred_df <- data.frame(ode(y=init_conds, times=c(0, 4, 18, 30), func=ode_func, parms=param))%>%
mutate(wt_Total = y1+y2+y3,
wt_prop_brdu = (y1+y2)/wt_Total,
dko_Total = y4+y5+y6,
dko_prop_brdu = (y4+y5)/dko_Total) %>%
filter(time != 0) %>% rename(Time_h = time)
pred_wt <- pred_df %>%
select(Time_h, contains('wt'))
pred_dko <- pred_df %>%
select(Time_h, contains('dko'))
wt_total <-  boot_data1$Total
wt_frac <-  boot_data1$prop_brdu
dko_total <-  boot_data2$Total
dko_frac <-  boot_data2$prop_brdu
R1 <- sum((asin_transf(pred_wt$wt_prop_brdu[time_index1]) - asin_transf(wt_frac))^2)
# R2 <- sum((log(pred_wt$wt_Total[time_index1]) - log(wt_total))^2)
R3 <- sum((asin_transf(pred_dko$dko_prop_brdu[time_index2]) - asin_transf(dko_frac))^2)
# R4 <- sum((log(pred_dko$dko_Total[time_index2]) - log(dko_total))^2)
logl <- -(n1/2)*(log(R1))  - (n2/2)*(log(R3))
return(-logl)
}
fit_LL <- optim(par=params, fn=LL_func,
boot_data1 = large_preB_wt, boot_data2 = large_preB_dko, init_conds = init_cond,
method = "Nelder-Mead",
control = list(trace = 6, maxit=2000))
fit_LL
par_est <- fit_LL$par
exp(fit_LL$par)
## predictions
pred_df <- data.frame(ode(y=init_cond, times=seq(0, 30, by=0.01), func=ode_func, parms=par_est))%>%
mutate(wt_Total = y1+y2+y3,
wt_prop_brdu = (y1+y2)/wt_Total,
dko_Total = y4+y5+y6,
dko_prop_brdu = (y4+y5)/dko_Total,
Time_h = time) %>%
select(Time_h, contains('prop')) %>%
gather(-Time_h, key = "genotype", value = "prop_brdu") %>%
mutate(Genotype = ifelse(grepl("wt", genotype), "WT", "dKO"))
ggplot()+
geom_point(data = large_preB_df, aes(x=Time_h, y=prop_brdu *100, col=Genotype))+
geom_line(data = pred_df, aes(x=Time_h, y=prop_brdu*100, col=Genotype)) +
facet_wrap(.~ Genotype)+
xlim(0, 31) + ylim(0, 80)
eps_func_hill <- function(Time, r_eps){
1/(1+ (Time/r_eps)^1)
}
eps_vec_hill <- sapply(ts_pred, eps_func_hill, r_eps = 7)
# ggplot()+
#   geom_line(aes(x = ts_pred, y=eps_vec_hill), col=4)+
#   geom_line(aes(x = ts_pred, y=eps_vec))+
#   scale_x_log10(limits=c(0.01, 30), breaks=c(0.01, 0.03, 0.1, 0.3, 1, 3, 10, 30))
eps_func <- function(Time, r_eps){
#eps_func_exp(Time, r_eps)
eps_func_hill(Time, r_eps)
}
ode_func <- function (Time, y, parms) {
pro_pos = (131619) #counts_df %>% filter(subpop == "BrdU_Pro_B") %>%
#summarise(mean(cell_counts))
pro_neg = (378491.4) #counts_df %>% filter(subpop == "Pro_B") %>%
#summarise(mean(cell_counts)) - pro_pos
with(as.list(c(y, parms)),{
delta = exp(delta_log)
rho = exp(rho_log)
rho_dko = exp(rho_dko_log)
delta_dko = exp(delta_dko_log)
r_eps = 6.5
theta = (rho - delta) * (y1+y2+y3)/(pro_neg+pro_pos)
theta_dko = (rho_dko - delta_dko) * (y4+y5+y6)/(pro_neg+pro_pos)
alpha = 1
## in WT
# L2 pop
dy1 <- theta * (1 - alpha) * pro_pos + rho * eps_func(Time, r_eps) * (2*y2 + y1) - rho * (1-eps_func(Time, r_eps)) * y1 - delta * y1
# L1 pop
dy2 <- theta * alpha * pro_pos + rho * eps_func(Time, r_eps) * (2*y3 - y1) + 2 * rho * (1-eps_func(Time, r_eps)) * y1 - delta * y2
# U pop
dy3 <- theta * pro_neg - rho * eps_func(Time, r_eps) * y3 + rho * (1-eps_func(Time, r_eps)) * (y2 + y3) - delta * y3
## in DKO
# L2 pop
dy4 <- theta_dko * (1 - alpha) * pro_pos + rho_dko * eps_func(Time, r_eps) * (2*y5+ y4) - rho_dko * (1-eps_func(Time, r_eps)) * y4 - delta_dko * y4
# L1 pop
dy5 <- theta_dko * alpha * pro_pos + rho_dko * eps_func(Time, r_eps) * (2*y6 - y4) + 2 * rho_dko * (1-eps_func(Time, r_eps)) * y4 - delta_dko * y5
# U pop
dy6 <- theta_dko * pro_neg - rho_dko * eps_func(Time, r_eps) * y6 + rho_dko * (1-eps_func(Time, r_eps)) * (y5 + y6) - delta_dko * y6
list(c(dy1, dy2, dy3, dy4, dy5, dy6))
})
}
init_cond_wt <- c("y1" = 0.0, "y2" = 0, "y3" = 372151)
init_cond_dko <- c("y4" = 0.0, "y5" = 0, "y6" = 83027)
init_cond <- c(init_cond_wt, init_cond_dko)
params <- c("rho_log" = -3, "delta_log" = -5, "rho_dko_log" = -4, "delta_dko_log" = -5)#, "r_eps" = 0.5)
asin_transf <- function(x){asin(sqrt(x))}
pred_df <- data.frame(ode(y=init_cond, times=c(0, 4, 18, 30), func=ode_func, parms=params))%>%
mutate(wt_Total = y1+y2+y3,
wt_prop_brdu = (y1+y2)/wt_Total,
dko_Total = y4+y5+y6,
dko_prop_brdu = (y4+y5)/dko_Total) %>%
filter(time != 0) %>% rename(Time_h = time)
#model optimization
LL_func <- function(param, boot_data1, boot_data2, init_conds) {
k <- length(param)        #number of unknown parameters
n1 <-  nrow(boot_data1)
n2 <-  nrow(boot_data2)
pred_df <- data.frame(ode(y=init_conds, times=c(0, 4, 18, 30), func=ode_func, parms=param))%>%
mutate(wt_Total = y1+y2+y3,
wt_prop_brdu = (y1+y2)/wt_Total,
dko_Total = y4+y5+y6,
dko_prop_brdu = (y4+y5)/dko_Total) %>%
filter(time != 0) %>% rename(Time_h = time)
pred_wt <- pred_df %>%
select(Time_h, contains('wt'))
pred_dko <- pred_df %>%
select(Time_h, contains('dko'))
wt_total <-  boot_data1$Total
wt_frac <-  boot_data1$prop_brdu
dko_total <-  boot_data2$Total
dko_frac <-  boot_data2$prop_brdu
R1 <- sum((asin_transf(pred_wt$wt_prop_brdu[time_index1]) - asin_transf(wt_frac))^2)
# R2 <- sum((log(pred_wt$wt_Total[time_index1]) - log(wt_total))^2)
R3 <- sum((asin_transf(pred_dko$dko_prop_brdu[time_index2]) - asin_transf(dko_frac))^2)
# R4 <- sum((log(pred_dko$dko_Total[time_index2]) - log(dko_total))^2)
logl <- -(n1/2)*(log(R1))  - (n2/2)*(log(R3))
return(-logl)
}
fit_LL <- optim(par=params, fn=LL_func,
boot_data1 = large_preB_wt, boot_data2 = large_preB_dko, init_conds = init_cond,
method = "Nelder-Mead",
control = list(trace = 6, maxit=2000))
fit_LL
par_est <- fit_LL$par
exp(fit_LL$par)
## predictions
pred_df <- data.frame(ode(y=init_cond, times=seq(0, 30, by=0.01), func=ode_func, parms=par_est))%>%
mutate(wt_Total = y1+y2+y3,
wt_prop_brdu = (y1+y2)/wt_Total,
dko_Total = y4+y5+y6,
dko_prop_brdu = (y4+y5)/dko_Total,
Time_h = time) %>%
select(Time_h, contains('prop')) %>%
gather(-Time_h, key = "genotype", value = "prop_brdu") %>%
mutate(Genotype = ifelse(grepl("wt", genotype), "WT", "dKO"))
ggplot()+
geom_point(data = large_preB_df, aes(x=Time_h, y=prop_brdu *100, col=Genotype))+
geom_line(data = pred_df, aes(x=Time_h, y=prop_brdu*100, col=Genotype)) +
facet_wrap(.~ Genotype)+
xlim(0, 31) + ylim(0, 80)
eps_func_hill <- function(Time, r_eps){
1/(1+ (Time/r_eps)^1)
}
eps_vec_hill <- sapply(ts_pred, eps_func_hill, r_eps = 7)
# ggplot()+
#   geom_line(aes(x = ts_pred, y=eps_vec_hill), col=4)+
#   geom_line(aes(x = ts_pred, y=eps_vec))+
#   scale_x_log10(limits=c(0.01, 30), breaks=c(0.01, 0.03, 0.1, 0.3, 1, 3, 10, 30))
eps_func <- function(Time, r_eps){
#eps_func_exp(Time, r_eps)
eps_func_hill(Time, r_eps)
}
ode_func <- function (Time, y, parms) {
pro_pos = (131619) #counts_df %>% filter(subpop == "BrdU_Pro_B") %>%
#summarise(mean(cell_counts))
pro_neg = (378491.4) #counts_df %>% filter(subpop == "Pro_B") %>%
#summarise(mean(cell_counts)) - pro_pos
with(as.list(c(y, parms)),{
delta = exp(delta_log)
rho = exp(rho_log)
rho_dko = exp(rho_dko_log)
delta_dko = exp(delta_dko_log)
r_eps = 4
theta = (rho - delta) * (y1+y2+y3)/(pro_neg+pro_pos)
theta_dko = (rho_dko - delta_dko) * (y4+y5+y6)/(pro_neg+pro_pos)
alpha = 1
## in WT
# L2 pop
dy1 <- theta * (1 - alpha) * pro_pos + rho * eps_func(Time, r_eps) * (2*y2 + y1) - rho * (1-eps_func(Time, r_eps)) * y1 - delta * y1
# L1 pop
dy2 <- theta * alpha * pro_pos + rho * eps_func(Time, r_eps) * (2*y3 - y1) + 2 * rho * (1-eps_func(Time, r_eps)) * y1 - delta * y2
# U pop
dy3 <- theta * pro_neg - rho * eps_func(Time, r_eps) * y3 + rho * (1-eps_func(Time, r_eps)) * (y2 + y3) - delta * y3
## in DKO
# L2 pop
dy4 <- theta_dko * (1 - alpha) * pro_pos + rho_dko * eps_func(Time, r_eps) * (2*y5+ y4) - rho_dko * (1-eps_func(Time, r_eps)) * y4 - delta_dko * y4
# L1 pop
dy5 <- theta_dko * alpha * pro_pos + rho_dko * eps_func(Time, r_eps) * (2*y6 - y4) + 2 * rho_dko * (1-eps_func(Time, r_eps)) * y4 - delta_dko * y5
# U pop
dy6 <- theta_dko * pro_neg - rho_dko * eps_func(Time, r_eps) * y6 + rho_dko * (1-eps_func(Time, r_eps)) * (y5 + y6) - delta_dko * y6
list(c(dy1, dy2, dy3, dy4, dy5, dy6))
})
}
init_cond_wt <- c("y1" = 0.0, "y2" = 0, "y3" = 372151)
init_cond_dko <- c("y4" = 0.0, "y5" = 0, "y6" = 83027)
init_cond <- c(init_cond_wt, init_cond_dko)
params <- c("rho_log" = -3, "delta_log" = -5, "rho_dko_log" = -4, "delta_dko_log" = -5)#, "r_eps" = 0.5)
asin_transf <- function(x){asin(sqrt(x))}
pred_df <- data.frame(ode(y=init_cond, times=c(0, 4, 18, 30), func=ode_func, parms=params))%>%
mutate(wt_Total = y1+y2+y3,
wt_prop_brdu = (y1+y2)/wt_Total,
dko_Total = y4+y5+y6,
dko_prop_brdu = (y4+y5)/dko_Total) %>%
filter(time != 0) %>% rename(Time_h = time)
#model optimization
LL_func <- function(param, boot_data1, boot_data2, init_conds) {
k <- length(param)        #number of unknown parameters
n1 <-  nrow(boot_data1)
n2 <-  nrow(boot_data2)
pred_df <- data.frame(ode(y=init_conds, times=c(0, 4, 18, 30), func=ode_func, parms=param))%>%
mutate(wt_Total = y1+y2+y3,
wt_prop_brdu = (y1+y2)/wt_Total,
dko_Total = y4+y5+y6,
dko_prop_brdu = (y4+y5)/dko_Total) %>%
filter(time != 0) %>% rename(Time_h = time)
pred_wt <- pred_df %>%
select(Time_h, contains('wt'))
pred_dko <- pred_df %>%
select(Time_h, contains('dko'))
wt_total <-  boot_data1$Total
wt_frac <-  boot_data1$prop_brdu
dko_total <-  boot_data2$Total
dko_frac <-  boot_data2$prop_brdu
R1 <- sum((asin_transf(pred_wt$wt_prop_brdu[time_index1]) - asin_transf(wt_frac))^2)
# R2 <- sum((log(pred_wt$wt_Total[time_index1]) - log(wt_total))^2)
R3 <- sum((asin_transf(pred_dko$dko_prop_brdu[time_index2]) - asin_transf(dko_frac))^2)
# R4 <- sum((log(pred_dko$dko_Total[time_index2]) - log(dko_total))^2)
logl <- -(n1/2)*(log(R1))  - (n2/2)*(log(R3))
return(-logl)
}
fit_LL <- optim(par=params, fn=LL_func,
boot_data1 = large_preB_wt, boot_data2 = large_preB_dko, init_conds = init_cond,
method = "Nelder-Mead",
control = list(trace = 6, maxit=2000))
fit_LL
par_est <- fit_LL$par
exp(fit_LL$par)
## predictions
pred_df <- data.frame(ode(y=init_cond, times=seq(0, 30, by=0.01), func=ode_func, parms=par_est))%>%
mutate(wt_Total = y1+y2+y3,
wt_prop_brdu = (y1+y2)/wt_Total,
dko_Total = y4+y5+y6,
dko_prop_brdu = (y4+y5)/dko_Total,
Time_h = time) %>%
select(Time_h, contains('prop')) %>%
gather(-Time_h, key = "genotype", value = "prop_brdu") %>%
mutate(Genotype = ifelse(grepl("wt", genotype), "WT", "dKO"))
ggplot()+
geom_point(data = large_preB_df, aes(x=Time_h, y=prop_brdu *100, col=Genotype))+
geom_line(data = pred_df, aes(x=Time_h, y=prop_brdu*100, col=Genotype)) +
facet_wrap(.~ Genotype)+
xlim(0, 31) + ylim(0, 80)
eps_func_hill <- function(Time, r_eps){
1/(1+ (Time/r_eps)^1)
}
eps_vec_hill <- sapply(ts_pred, eps_func_hill, r_eps = 7)
# ggplot()+
#   geom_line(aes(x = ts_pred, y=eps_vec_hill), col=4)+
#   geom_line(aes(x = ts_pred, y=eps_vec))+
#   scale_x_log10(limits=c(0.01, 30), breaks=c(0.01, 0.03, 0.1, 0.3, 1, 3, 10, 30))
eps_func <- function(Time, r_eps){
#eps_func_exp(Time, r_eps)
eps_func_hill(Time, r_eps)
}
ode_func <- function (Time, y, parms) {
pro_pos = (131619) #counts_df %>% filter(subpop == "BrdU_Pro_B") %>%
#summarise(mean(cell_counts))
pro_neg = (378491.4) #counts_df %>% filter(subpop == "Pro_B") %>%
#summarise(mean(cell_counts)) - pro_pos
with(as.list(c(y, parms)),{
delta = exp(delta_log)
rho = exp(rho_log)
rho_dko = exp(rho_dko_log)
delta_dko = exp(delta_dko_log)
r_eps = 4
theta = (rho - delta) * (y1+y2+y3)/(pro_neg+pro_pos)
theta_dko = (rho_dko - delta_dko) * (y4+y5+y6)/(pro_neg+pro_pos)
alpha = 0.1
## in WT
# L2 pop
dy1 <- theta * (1 - alpha) * pro_pos + rho * eps_func(Time, r_eps) * (2*y2 + y1) - rho * (1-eps_func(Time, r_eps)) * y1 - delta * y1
# L1 pop
dy2 <- theta * alpha * pro_pos + rho * eps_func(Time, r_eps) * (2*y3 - y1) + 2 * rho * (1-eps_func(Time, r_eps)) * y1 - delta * y2
# U pop
dy3 <- theta * pro_neg - rho * eps_func(Time, r_eps) * y3 + rho * (1-eps_func(Time, r_eps)) * (y2 + y3) - delta * y3
## in DKO
# L2 pop
dy4 <- theta_dko * (1 - alpha) * pro_pos + rho_dko * eps_func(Time, r_eps) * (2*y5+ y4) - rho_dko * (1-eps_func(Time, r_eps)) * y4 - delta_dko * y4
# L1 pop
dy5 <- theta_dko * alpha * pro_pos + rho_dko * eps_func(Time, r_eps) * (2*y6 - y4) + 2 * rho_dko * (1-eps_func(Time, r_eps)) * y4 - delta_dko * y5
# U pop
dy6 <- theta_dko * pro_neg - rho_dko * eps_func(Time, r_eps) * y6 + rho_dko * (1-eps_func(Time, r_eps)) * (y5 + y6) - delta_dko * y6
list(c(dy1, dy2, dy3, dy4, dy5, dy6))
})
}
init_cond_wt <- c("y1" = 0.0, "y2" = 0, "y3" = 372151)
init_cond_dko <- c("y4" = 0.0, "y5" = 0, "y6" = 83027)
init_cond <- c(init_cond_wt, init_cond_dko)
params <- c("rho_log" = -3, "delta_log" = -5, "rho_dko_log" = -4, "delta_dko_log" = -5)#, "r_eps" = 0.5)
asin_transf <- function(x){asin(sqrt(x))}
pred_df <- data.frame(ode(y=init_cond, times=c(0, 4, 18, 30), func=ode_func, parms=params))%>%
mutate(wt_Total = y1+y2+y3,
wt_prop_brdu = (y1+y2)/wt_Total,
dko_Total = y4+y5+y6,
dko_prop_brdu = (y4+y5)/dko_Total) %>%
filter(time != 0) %>% rename(Time_h = time)
#model optimization
LL_func <- function(param, boot_data1, boot_data2, init_conds) {
k <- length(param)        #number of unknown parameters
n1 <-  nrow(boot_data1)
n2 <-  nrow(boot_data2)
pred_df <- data.frame(ode(y=init_conds, times=c(0, 4, 18, 30), func=ode_func, parms=param))%>%
mutate(wt_Total = y1+y2+y3,
wt_prop_brdu = (y1+y2)/wt_Total,
dko_Total = y4+y5+y6,
dko_prop_brdu = (y4+y5)/dko_Total) %>%
filter(time != 0) %>% rename(Time_h = time)
pred_wt <- pred_df %>%
select(Time_h, contains('wt'))
pred_dko <- pred_df %>%
select(Time_h, contains('dko'))
wt_total <-  boot_data1$Total
wt_frac <-  boot_data1$prop_brdu
dko_total <-  boot_data2$Total
dko_frac <-  boot_data2$prop_brdu
R1 <- sum((asin_transf(pred_wt$wt_prop_brdu[time_index1]) - asin_transf(wt_frac))^2)
# R2 <- sum((log(pred_wt$wt_Total[time_index1]) - log(wt_total))^2)
R3 <- sum((asin_transf(pred_dko$dko_prop_brdu[time_index2]) - asin_transf(dko_frac))^2)
# R4 <- sum((log(pred_dko$dko_Total[time_index2]) - log(dko_total))^2)
logl <- -(n1/2)*(log(R1))  - (n2/2)*(log(R3))
return(-logl)
}
fit_LL <- optim(par=params, fn=LL_func,
boot_data1 = large_preB_wt, boot_data2 = large_preB_dko, init_conds = init_cond,
method = "Nelder-Mead",
control = list(trace = 6, maxit=2000))
fit_LL
par_est <- fit_LL$par
exp(fit_LL$par)
## predictions
pred_df <- data.frame(ode(y=init_cond, times=seq(0, 30, by=0.01), func=ode_func, parms=par_est))%>%
mutate(wt_Total = y1+y2+y3,
wt_prop_brdu = (y1+y2)/wt_Total,
dko_Total = y4+y5+y6,
dko_prop_brdu = (y4+y5)/dko_Total,
Time_h = time) %>%
select(Time_h, contains('prop')) %>%
gather(-Time_h, key = "genotype", value = "prop_brdu") %>%
mutate(Genotype = ifelse(grepl("wt", genotype), "WT", "dKO"))
ggplot()+
geom_point(data = large_preB_df, aes(x=Time_h, y=prop_brdu *100, col=Genotype))+
geom_line(data = pred_df, aes(x=Time_h, y=prop_brdu*100, col=Genotype)) +
facet_wrap(.~ Genotype)+
xlim(0, 31) + ylim(0, 80)
